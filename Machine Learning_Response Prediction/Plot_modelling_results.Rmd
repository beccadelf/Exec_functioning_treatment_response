---
title: "Plot_ML-Analysis_Results"
author: "Rebecca Delfendahl"
date: "2024-11-15"
output: html_document
---
# Setup
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages
```{r}
library(readr)
library(dplyr)
library(ggplot2)
```

# Plot Settings
```{r}
size_text = 10
family = "Arial"
theme_set(theme_classic() + theme(text = element_text(size = size_text, family = family),
                                  axis.title = element_text(size = size_text +2, family = family),
                                  #plot.title = element_text(size = size_text, family = family),
                                  #axis.text = element_text(size = size_text, family = family),
                                  #strip.text =  element_text(size = size_text +4, family = family),
                                  #legend.text =  element_text(size = size_text, family = family)
                                  ))
```

# Load and combine results
```{r}
# Get all folders in the results folder (each containing the results of another model)
path_results_folder = "Z:\\Projekte_Meinke\\Old_projects\\Labrotation_Rebecca\\2_Machine_learning\\Results"
results_folders <- list.files(path = path_results_folder, full.names = FALSE)

# For each folder, save the performance_across_iters-file in dictionary
results_dict = list()
for (folder_name in results_folders) {
  # Read the file and store it as a dictionary
  results_dict[[folder_name]] <- read.delim(file.path(path_results_folder, folder_name,
                                                      "performance_across_iters.txt"))
}

# Combine results
combined_results <- bind_rows(results_dict, .id = "FolderName")
# Rename folder-names
combined_results$FolderName <- gsub("random_forest","rf",combined_results$FolderName)
combined_results$FolderName <- gsub("svm","svm_classifier",combined_results$FolderName) # TODO: delete if scrips have been re-run
combined_results$FolderName <- gsub("_no_oversampling","",combined_results$FolderName)
combined_results$FolderName <- gsub("yes_oversampling","oversampled",combined_results$FolderName)
combined_results$FolderName <- gsub("clinical_features_only","clinical_features",combined_results$FolderName)
combined_results$X <- NULL

# Separate into regressor and classifier dataframes
classification_results <- combined_results[grepl("classifier", combined_results$FolderName), ]
regression_results <- combined_results[grepl("regressor", combined_results$FolderName), ]
```

# Function to XXX
```{r}
# # Group models for color coding
# group_mapping <- c("clinical_features_rf_classifier" = "Group1", "all_features_rf_classifier" = "Group1",
#                    "clinical_features_rf_classifier_oversampled" = "Group2", "all_features_rf_classifier_oversampled" = "Group2",
#                    "clinical_features_svm_classifier" = "Group3", "all_features_svm_classifier" = "Group3",
#                    "clinical_features_svm_classifier_oversampled" = "Group4", "all_features_svm_classifier_oversampled" = "Group4")
# classification_results$Group <- group_mapping[classification_results$FolderName]
# 
# # Assign colors based on element position within each group
# classification_results <- classification_results %>%
#   group_by(Group) %>%
#   mutate(ElementPosition = row_number()) %>%  # Assign position within each group
#   ungroup()
# classification_results$ElementColor <- ifelse(classification_results$ElementPosition == 1, "Color1", "Color2")

create_classification_plot <- function(results_df){
  # Set factor levels for FolderName to control the x-axis order
  results_df$FolderName <- factor(results_df$FolderName, levels = c(
    "clinical_features_rf_classifier","all_features_rf_classifier",
    "clinical_features_rf_classifier_oversampled","all_features_rf_classifier_oversampled",
    "clinical_features_svm_classifier","all_features_svm_classifier",
    "clinical_features_svm_classifier_oversampled","all_features_svm_classifier_oversampled"))
  
  ## Define alternating colors for the x-axis levels
  #colors <- c("white", "#D3D3D3", "white", "#D3D3D3", "white", "#D3D3D3","white", "#D3D3D3")
  
  # Define colors and their labels for the legend
  colors <- c("Clinical Features" = "white", "All Features" = "#D3D3D3")
  results_df$FeatureGroup <- ifelse(grepl("clinical_features", results_df$FolderName),
                                    "Clinical Features", "All Features")
  
  # Create ggplot
  plot <- ggplot(results_df, aes(x=FolderName, y=balanced_accuracy, fill=FeatureGroup)) +
    geom_violin(scale = "width") +
    geom_jitter(size = 1) +
    stat_summary(
      geom = "point",
      shape = 24,
      fun = "mean",
      col = "black",
      fill = "red",
      size = 3
    ) +
    labs(y = "Balanced accuracy",  x = "", fill = "Feature Group") + 
    scale_y_continuous(breaks = c(0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8)) +
    scale_fill_manual(values = colors) + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

  return(plot)
}

classification_plot <- create_classification_plot(results_df = classification_results)
```

# Function to XXX
```{r}
create_regression_plot <- function(results_df){
  # Set factor levels for FolderName to control the x-axis order
  results_df$FolderName <- factor(results_df$FolderName, levels = c(
    "clinical_features_rf_regressor", "all_features_rf_regressor",
    "clinical_features_ridge_regressor", "all_features_ridge_regressor"))
  
  # Create ggplot
  plot <- ggplot(results_df, aes(x=FolderName, y=MSE)) +
    geom_violin() +
    stat_summary(
      geom = "point",
      shape = 24,
      fun = "mean",
      col = "black",
      fill = "red",
      size = 3
    ) +
    labs(y = "Mean squared error",  x = "") + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

  return(plot)
}

regression_plot <- create_regression_plot(results_df = regression_results)
```
