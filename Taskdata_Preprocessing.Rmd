---
title: "Taskdata_Preprocessing"
author: "Rebecca Delfendahl"
date: "2024-09-17"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

```{r R Setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(kableExtra)
library(tidyverse)
library(haven)
library(rmatio)
library(data.table)
library(SSRTcalc)
```

# 0. Initial configurations
```{r}
basic_path = "Z:/Projekte_Meinke/Old_projects/Labrotation_Rebecca/Rohdaten/Task_battery/Task_battery"
```

## 0.1. Define functions
```{r Define functions}

########################################
## Function 1: get relevant data from mat-file for a single subject
########################################
df_from_matlab <- function(task_name, subject){
  file_name = paste("SFB_C5_",subject,"_",task_name,".mat", sep = "")
  data_path = file.path(basic_path,file_name)
  data <- read.mat(data_path)
  # So far, we only need TrialList_Log_ -> it is the combination of TL_ und LogMat
  subtask = paste("TrialList_Log_",task_name,sep = "")
  task_df <- as.data.frame(rbindlist(data[[subtask]]))
  header <- paste(subtask, "Header", sep = "_")
  colnames(task_df) <- c(rbindlist(data[[header]])[1,])
  return(task_df)
}

########################################
## Function 2: preprocessing of RT and PC
########################################
preprocess_RT_PC <- function(task, subjects){
  
  # Initialize empty list to store preprocessed data
  all_data_list <- list()
  
  # Loop across all participants
  for (subject in subjects) {
    # Import data
    data <- df_from_matlab(task_name = task, subject = subject)
    
    # Bring data NumberLetter and data Stroop to same format
    if (task == "NumberLetter"){
      colnames(data) <- sub(" ", "_", colnames(data))
      data <- data %>%
        rename("Condition"="Task_transition")
    } else if (task == "Stroop"){
        data <- data %>%
          rename("Accuracy"="Fehler")
    }
    
    # Basic preprocessing
    data_red <- data %>%
      # Select relevant columns
      select(Condition, Response, Accuracy, RT) %>%
      # Discard first trial (only applies to NumbLet)
      filter(Condition != "NoPreviousTrial")
    
    # Convert RTs & Accuracy to numeric
    data_red$RT <- as.numeric(data_red$RT)
    data_red$Accuracy <- as.numeric(data_red$Accuracy)
    
    # STEP 1.1.: Processing data for RT analysis
    
    data_RT_clean <- data_red %>%
      ## Step 1: Change RT to ms
      mutate(RT = RT * 1000) %>%
      ## Step 2: Remove outlier
      filter(RT > 150)
    
    # STEP 1.2.: Compute mean RT overall and per condition 
    
    overall_RT_mean <- mean(data_RT_clean$RT)
    
    RT_means <- data_RT_clean %>%
      group_by(Condition) %>%
      summarize_at(vars(RT), mean)
    
    ## Transform data from LONG to WIDE format
    wideData_RT <- RT_means %>%
      pivot_wider(names_from = Condition, values_from = RT)
    
      
    # STEP 2: Compute proportion correct overall and per condition 
    overall_PC <- mean(data_red$Accuracy)
    
    PC <- data_red %>%
      group_by(Condition) %>%
      summarize_at(vars(Accuracy), mean)
    
    ## TODO: Convert to percentages?
    
    ## Transform data from LONG to WIDE format
    wideData_PC <- PC %>%
      pivot_wider(names_from = Condition, values_from = Accuracy)
    
    # STEP 3: Merging the two wide dataframe
    
    ## Update column names to include the variable identity
    colnames(wideData_RT) <- paste(colnames(wideData_RT),"RT", sep="_")
    colnames(wideData_PC) <- paste(colnames(wideData_PC),"PC", sep="_")
    
    ## Merge dataframes
    wideData_merged <- cbind(wideData_RT, wideData_PC)
    
    # STEP 4: Adding extra relevant info
    
    ## Add subject ID, overall mean RT and overall PC
    wideData_merged$Subject <- subject
    wideData_merged$Overall_RT <- overall_RT_mean
    wideData_merged$Overall_PC <- overall_PC
    
    ## Store the current processed data into holder list
    all_data_list[[subject]] <- wideData_merged
  }
  # Bind all rows together
  AllData <- bind_rows(all_data_list)
  return(AllData)
}

```

# 1. Get list of all subjects

For each subject, we have 5 matlab dataframes:
- TwoBack
- StopSignal
- Stroop
- Stroop_mouse
- NumberLetter
- ExpOrder

```{r List of all subjects}

files <- list.files(basic_path)

sub_first <- gsub("SFB_C5_","",files)
sub_IDs <- sapply(strsplit(sub_first, "_"), function(x) x[1])
subjects <- unique(sub_IDs)
# Delete alt and "" from subjects
subjects <- subjects[subjects != "alt"]
subjects <- subjects[subjects != ""]
```

# 2. Import and preprocess task data 
For each subject and task (Number-Letter, Stroop and Two-Back task) separately
```{r Looping across all subjects}

AllData_NumbLet <- preprocess_RT_PC(task = "NumberLetter", subjects = subjects)
AllData_Stroop <- preprocess_RT_PC(task = "Stroop", subjects = subjects)
AllData_TwoBack <- preprocess_RT_PC(task = "TwoBack", subjects = subjects)
```

# 3. Calculate SSRT of each subject (integrative method)
Info: adaptive version of SST was used: the initial SSD of 200 ms was adapted after each “stop” trial by adding 50 ms for a (correct) nonresponse, and subtracting 50 ms for a (faulty) response
```{r SSRT}
# Initialize empty holder list
AllData_SST <- data.frame()

for (subject in subjects) {
  data_SST <- df_from_matlab(task_name = "StopSignal", subject = subject)
  
  # Reduce to only relevant variables
  data_SST_red <- data_SST %>%
    select(Condition, RT, Accuracy, `Stop-signal delay`)
  
  # Recode condition: Go -> 0, Stop -> 1
  data_SST_red$Condition <- ifelse(data_SST_red$Condition == "Go", 0, 1)
  # Convert all columns to numeric
  data_SST_red[] <- lapply(data_SST_red, as.numeric)
  
  # Calculate SSRT
  SSRT_value <- integration_adaptiveSSD(data_SST_red, stop_col = "Condition", rt_col = "RT",
                                        acc_col = "Accuracy", ssd_col = "Stop-signal delay")
  
  # Append the result to holder dataframe
  AllData_SST <- rbind(AllData_SST, data.frame(Subject = subject, SSRT = SSRT_value))
}
```

# 4. Save preprocessed task data
```{r Save as .csv}
file_path <- "Z:/Projekte_Meinke/Old_projects/Labrotation_Rebecca/Daten_Gruppenvergleich/With_wrong_responses/Task_Data/"

write.csv(AllData_NumbLet, paste0(file_path, "AllData_NumbLet.csv"), row.names = FALSE)
write.csv(AllData_Stroop, paste0(file_path, "AllData_Stroop.csv"), row.names = FALSE)
write.csv(AllData_TwoBack, paste0(file_path, "AllData_TwoBack.csv"), row.names = FALSE)
write.csv(AllData_SST, paste0(file_path, "AllData_SST.csv"), row.names = FALSE)
```