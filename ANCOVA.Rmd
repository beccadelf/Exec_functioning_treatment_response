---
title: "Group Comparison"
authors: "Charlotte Meinke, Rebecca Delfendahl, Till Julius Adam"
date: "2024-09-04"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---
<style type="text/css">
.main-container { /* Adjust main blocks */
  max-width: 100% !important;
  margin: auto;
}

body {
  font-family: "Georgia", serif !important; /* Set the font for the entire document */
}

.tocify { /* Adjust table of contents */
  max-width: 100% !important;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(tidyr)
library(pander)
library(effsize)
library(pwr)
library(gtsummary)
library(stats)
library(lmtest)
library(sandwich)
library(nlme)
```


## <u>Importing Data</u>

### Task Performance Data
```{r}
data_HC <- read.csv("Z:/Projekte_Meinke/Old_projects/Labrotation_Rebecca/Daten_Gruppenvergleich/With_wrong_responses/Data_HC.csv")
data_Pat_pre <- read.csv("Z:/Projekte_Meinke/Old_projects/Labrotation_Rebecca/Daten_Gruppenvergleich/With_wrong_responses/Data_Patients_Pre.csv")
data_Pat_post <- read.csv("Z:/Projekte_Meinke/Old_projects/Labrotation_Rebecca/Daten_Gruppenvergleich/With_wrong_responses/Data_Patients_Post.csv")
```

### Subject Data
```{r}
data_all <- haven::read_dta('Z:/Projekte_Meinke/Old_projects/Labrotation_Rebecca/CognitiveControl_Treatment/Data_Kevin_28.07.23.dta')
colnames(data_all)[which(colnames(data_all) == "id")] <- "Subject"
```

## <u>Comparison HC vs. Patients</u>

### Prepare dataset
```{r}
## 1. Merge patients pre and controls
Patients_vs_HC <- rbind(data_Pat_pre, data_HC)

## 2. Reduce dataset to BIS columns and SSRT
BIS_columns <- colnames(Patients_vs_HC)[grep("BIS", colnames(Patients_vs_HC))]
imp_columns <- c(BIS_columns, "SSRT")
Patients_vs_HC_imp <- Patients_vs_HC[,c("Subject","Gruppe",imp_columns)]

## 3. Add confounds (Alter, Geschlecht, Abschluss)
Patients_vs_HC_imp_conf <- merge(data_all[,c("Subject","Alter","Geschlecht","Abschluss")], Patients_vs_HC_imp, by = "Subject")

# Extract the performance tasks automatically from the dataset (same logic as used in ANCOVA)
performance_tasks <- colnames(Patients_vs_HC_imp_conf)[grep("BIS|SSRT", colnames(Patients_vs_HC_imp_conf))]
```
Data for `r nrow(Patients_vs_HC_imp[Patients_vs_HC_imp$Gruppe == 1,])` patients and `r nrow(Patients_vs_HC_imp[Patients_vs_HC_imp$Gruppe == 0,])` healthy controls were available.

### **Control Welch-test for covariates age, sex, and education**
#### Descriptive statistics
```{r}
#Descriptive statistics
table1 <- 
  Patients_vs_HC_imp_conf %>%
  tbl_summary(include = c(Alter, Geschlecht, Abschluss), by = Gruppe)
pander(as.data.frame(table1))
```

#### Testing assumptions for ANCOVA
<u>1. Linearity between age and performance, corrected for group, education, and sex</u>
```{r}
# both sex and education are categorical variables
# ergo, only age will be tested for linearity
# note: as an unconventional but possible analysis, linearity could be plotted for education across the categories, but that would be explorative
# controlling for sex, education, and group, we plot the residuals of performance against the covariate age

# Loop through each task performance variable and plot residuals against Age
for (task in performance_tasks) {
  # Filter out rows with missing values in relevant variables before running the model
  model_data <- na.omit(Patients_vs_HC_imp_conf[, c(task, "Gruppe", "Geschlecht", "Abschluss", "Alter")])
  
  # Build the linear model controlling for Group, Gender, and Education
  model <- lm(as.formula(paste(task, "~ Gruppe + Geschlecht + Abschluss")), data = model_data)
  
  # Extract the residuals
  model_data$residuals <- resid(model)
  
  # Create the scatterplot of residuals vs. Age using tidy evaluation for dynamic column names
  p <- ggplot(model_data, aes(x = Alter, y = residuals)) +
    geom_point(alpha = 0.6) +  # Scatterplot points
    geom_smooth(method = "loess", se = FALSE, color = "blue") +  # Lowess Fit Line
    labs(title = paste("Residuals vs. Age for", task),
         x = "Age",
         y = "Residuals") +
    theme_minimal()
  
  # Print the plot to ensure it is displayed
  print(p)
}
```

<u>1.2 Linearity of direct relationship between a covariate and the outcome within the groups</u>
```{r}
# Loop through each task performance variable and plot Age vs. Task Performance within groups (HC vs. Pat)
for (task in performance_tasks) {
  # Create the scatterplot of Age vs. Task Performance with Lowess Fit Line by group
  p <- ggplot(Patients_vs_HC_imp_conf, aes(x = Alter, y = !!sym(task), color = as.factor(Gruppe))) +
    geom_point(alpha = 0.6) +  # Scatterplot points
    geom_smooth(method = "loess", se = FALSE) +  # Lowess Fit Line per group
    labs(title = paste("Age vs.", task, "for HC vs. Pat"),
         x = "Age",
         y = task,
         color = "Group") +  # Correct label for legend
    scale_color_manual(values = c("blue", "red"), labels = c("HC", "Pat")) +  # Define colors and labels for groups
    theme_minimal()
  
  # Print the plot to ensure it is displayed
  print(p)
}
```

<u>2. Homoscedasticity of residuals</u>
```{r}
# The model consists of 3 covariates. Sex is binary (2x2 ANOVA), education is categorical (2x4 ANOVA), and age is continuous (ANCOVA). 
# Testing for homoscedasticity, we employ Levene's test for the categorical (group comparison) covariates sex and education.
# For the continuous covariates, we employ Breusch-Pagan test which tests for heterogeneity of residuals along the continuous spectrum of the covariate of interest (in our case, that would be age)
# For the visual inspection of variance across age, we can also go back to the test for linearity and inspect the residuals.
# Furthermore, we test the whole model for homoscedasticity along the performance.

# Initialize a dataframe to store results, with an extra column for "Violated" or "Not Violated"
homoskedasticity_results <- data.frame(Task = performance_tasks, 
                                       Levene_sex_p_value = numeric(length(performance_tasks)),
                                       Levene_education_p_value = numeric(length(performance_tasks)),
                                       BP_age_specific_p_value = numeric(length(performance_tasks)),
                                       BP_model_p_value = numeric(length(performance_tasks)),
                                       Homoscedasticity_Violated = character(length(performance_tasks)),
                                       stringsAsFactors = FALSE)

# Loop through each task and perform the tests
for (i in seq_along(performance_tasks)) {
  task <- performance_tasks[i]
  model_data <- na.omit(Patients_vs_HC_imp_conf[, c(task, "Gruppe", "Geschlecht", "Abschluss", "Alter")])
  
  # Build the linear model controlling for Group, Gender, Education, and Age
  model <- lm(as.formula(paste(task, "~ Gruppe + Geschlecht + Abschluss + Alter")), data = model_data)
  
  # Extract the residuals
  model_data$residuals <- resid(model)
  
  # Levene Test for Sex (categorical)
  levene_test_sex <- car::leveneTest(residuals ~ as.factor(Gruppe) * as.factor(Geschlecht), data = model_data)
  homoskedasticity_results$Levene_sex_p_value[i] <- round(levene_test_sex$"Pr(>F)"[1], 2)
  
  # Levene Test for Education (Abschluss) (categorical)
  levene_test_education <- car::leveneTest(residuals ~ as.factor(Gruppe) * as.factor(Abschluss), data = model_data)
  homoskedasticity_results$Levene_education_p_value[i] <- round(levene_test_education$"Pr(>F)"[1], 2)
  
  # Breusch-Pagan Test for Age (Alter), adjusted for Gender and Education (continuous)
  age_specific_model <- lm(as.formula(paste(task, "~ Geschlecht + Abschluss + Gruppe")), data = model_data)
  bp_test_age <- bptest(age_specific_model)
  homoskedasticity_results$BP_age_specific_p_value[i] <- round(bp_test_age$p.value, 2)
  
  # Breusch-Pagan Test for the whole model (continuous)
  bp_test <- bptest(model)
  homoskedasticity_results$BP_model_p_value[i] <- round(bp_test$p.value, 2)
  
  # Check if any of the p-values are less than 0.05
  if (homoskedasticity_results$Levene_sex_p_value[i] < 0.05 || 
      homoskedasticity_results$Levene_education_p_value[i] < 0.05 || 
      homoskedasticity_results$BP_age_specific_p_value[i] < 0.05) {
    homoskedasticity_results$Homoscedasticity_Violated[i] <- "Violated"
  } else {
    homoskedasticity_results$Homoscedasticity_Violated[i] <- "Not Violated"
  }
}

# Output the table to review the results
pander(homoskedasticity_results, style = "rmarkdown", split.table = Inf, fontsize = "tiny")
```

<u>3. Interaction between covariates and predictor (categorical) and Homogeneity of slopes within regression (continuous)</u>
```{r}
# We cannot test homogeneity of slopes for the covariates of sex and education. 
# Instead, we test if there is a significant interaction between these covariates and group. 
# The test for the homogeneity of slopes determines if the regression slope between the continuous covariate age and the outcome of task performance is equivalent in both predictor groups.

# Initialize a dataframe to store results, with an extra column for "Violated" or "Not Violated"
interaction_results <- data.frame(Task = performance_tasks, 
                                  Interaction_Group_Sex_p_value = numeric(length(performance_tasks)),
                                  Interaction_Group_Education_p_value = numeric(length(performance_tasks)),
                                  Homogeneity_Slopes_Age_p_value = numeric(length(performance_tasks)),
                                  Interaction_Violated = character(length(performance_tasks)),  # New column
                                  stringsAsFactors = FALSE)

# Loop through each task and perform the interaction tests
for (i in seq_along(performance_tasks)) {
  task <- performance_tasks[i]
  
  # 1. Model to test the interaction between Group and Gender, controlled for Age and Education
  model_gender <- aov(as.formula(paste(task, "~ Gruppe * Geschlecht + Abschluss + Alter")), data = Patients_vs_HC_imp_conf)
  summary_model_gender <- summary(model_gender)
  
  # Extract the p-value for the interaction term Gruppe:Geschlecht
  interaction_gender_p_value <- summary_model_gender[[1]]$"Pr(>F)"[3]  # Third entry is for the interaction term Gruppe:Geschlecht
  interaction_results$Interaction_Group_Sex_p_value[i] <- round(interaction_gender_p_value, 2)
  
  # 2. Model to test the interaction between Group and Education, controlled for Gender and Age
  model_education <- aov(as.formula(paste(task, "~ Gruppe * Abschluss + Geschlecht + Alter")), data = Patients_vs_HC_imp_conf)
  summary_model_education <- summary(model_education)
  
  # Extract the p-value for the interaction term Gruppe:Abschluss
  interaction_education_p_value <- summary_model_education[[1]]$"Pr(>F)"[3]  # Third entry is for the interaction term Gruppe:Abschluss
  interaction_results$Interaction_Group_Education_p_value[i] <- round(interaction_education_p_value, 2)
  
  # 3. Model to test the homogeneity of slopes for Age, controlled for Gender and Education
  model_age <- aov(as.formula(paste(task, "~ Gruppe * Alter + Geschlecht + Abschluss")), data = Patients_vs_HC_imp_conf)
  summary_model_age <- summary(model_age)
  
  # Extract the p-value for the interaction term Gruppe:Alter (testing homogeneity of slopes)
  homogeneity_age_p_value <- summary_model_age[[1]]$"Pr(>F)"[3]  # Third entry is for the interaction term Gruppe:Alter
  interaction_results$Homogeneity_Slopes_Age_p_value[i] <- round(homogeneity_age_p_value, 2)
  
  # Check if any of the p-values are less than 0.05
  if (interaction_results$Interaction_Group_Sex_p_value[i] < 0.05 || 
      interaction_results$Interaction_Group_Education_p_value[i] < 0.05 || 
      interaction_results$Homogeneity_Slopes_Age_p_value[i] < 0.05) {
    interaction_results$Interaction_Violated[i] <- "Violated"
  } else {
    interaction_results$Interaction_Violated[i] <- "Not Violated"
  }
}

# Output the table to review the results
pander(interaction_results, style = "rmarkdown", split.table = Inf, fontsize = "tiny")
```

### Comprehensive ANCOVA
```{r}
# Modified function to include p-values for covariates
ANCOVA_mult_cols <- function(df_basis, cols, homoskedasticity_violations, interaction_violations, covariates){
  
  # Initialize a dataframe to store results
  df <- data.frame(
    p_value_uncorrected = numeric(length(cols)),  # For normal ANCOVA
    p_value_corrected = numeric(length(cols)),    # For corrected ANCOVA
    Alter_p_value = numeric(length(cols)),        # p-value for Alter
    Geschlecht_p_value = numeric(length(cols)),   # p-value for Geschlecht
    Abschluss_p_value = numeric(length(cols)),    # p-value for Abschluss
    Assumption_Violation = character(length(cols)),  # New column for violation status
    stringsAsFactors = FALSE
  )
  rownames(df) <- cols
  
  # Build the covariates
  covariate_formula <- paste(covariates, collapse = " + ")
  
  for (i in seq_along(cols)){
    col <- cols[i]
    
    # 1. ANCOVA (uncorrected) for every task
    formula_ancova <- paste(col, "~ Gruppe +", covariate_formula)
    ancova_model <- aov(as.formula(formula_ancova), data = df_basis)
    summary_ancova <- summary(ancova_model)
    
    # Store the p-value from the ANCOVA
    df[col, "p_value_uncorrected"] <- round(summary_ancova[[1]]$"Pr(>F)"[1], 2)
    
    # Store p-values for covariates (uncorrected model)
    df[col, "Alter_p_value"] <- round(summary_ancova[[1]]$"Pr(>F)"[2], 2)
    df[col, "Geschlecht_p_value"] <- round(summary_ancova[[1]]$"Pr(>F)"[3], 2)
    df[col, "Abschluss_p_value"] <- round(summary_ancova[[1]]$"Pr(>F)"[4], 2)
    
    # 2. Apply corrections based on assumption violations
    interaction_violation <- interaction_violations[i]
    homoskedasticity_violation <- homoskedasticity_violations[i]
    
    if (interaction_violation == "Violated" && homoskedasticity_violation == "Violated") {
      # Both violations: Apply robust standard errors and model interaction
      formula <- paste(col, "~ Gruppe * (", covariate_formula, ")")
      model <- lm(as.formula(formula), data = df_basis)
      robust_se <- vcovHC(model, type = "HC1")
      robust_summary <- coeftest(model, vcov = robust_se)
      df[col, "p_value_corrected"] <- round(robust_summary["Gruppe", "Pr(>|t|)"], 2)
      
      # Extract covariate p-values from the interaction robust model
      df[col, "Alter_p_value"] <- round(robust_summary["Alter", "Pr(>|t|)"], 2)
      df[col, "Geschlecht_p_value"] <- round(robust_summary["Geschlecht", "Pr(>|t|)"], 2)
      df[col, "Abschluss_p_value"] <- round(robust_summary["Abschluss", "Pr(>|t|)"], 2)
      
      df[col, "Assumption_Violation"] <- "Heteroscedasticity and Interaction"
      
    } else if (interaction_violation == "Violated") {
      # Only interaction violated: Model the interaction
      formula <- paste(col, "~ Gruppe * (", covariate_formula, ")")
      model <- aov(as.formula(formula), data = df_basis)
      summary_model <- summary(model)
      df[col, "p_value_corrected"] <- round(summary_model[[1]]$"Pr(>F)"[1], 2)
      
      # Extract covariate p-values from the interaction model
      df[col, "Alter_p_value"] <- round(summary_model[[1]]$"Pr(>F)"[2], 2)
      df[col, "Geschlecht_p_value"] <- round(summary_model[[1]]$"Pr(>F)"[3], 2)
      df[col, "Abschluss_p_value"] <- round(summary_model[[1]]$"Pr(>F)"[4], 2)
      
      df[col, "Assumption_Violation"] <- "Interaction"
      
    } else if (homoskedasticity_violation == "Violated") {
      # Only homoscedasticity violated: Apply robust standard errors
      formula <- paste(col, "~ Gruppe +", covariate_formula)
      model <- lm(as.formula(formula), data = df_basis)
      robust_se <- vcovHC(model, type = "HC1")
      robust_summary <- coeftest(model, vcov = robust_se)
      df[col, "p_value_corrected"] <- round(robust_summary["Gruppe", "Pr(>|t|)"], 2)
      
      # Extract covariate p-values from the robust model
      df[col, "Alter_p_value"] <- round(robust_summary["Alter", "Pr(>|t|)"], 2)
      df[col, "Geschlecht_p_value"] <- round(robust_summary["Geschlecht", "Pr(>|t|)"], 2)
      df[col, "Abschluss_p_value"] <- round(robust_summary["Abschluss", "Pr(>|t|)"], 2)
      
      df[col, "Assumption_Violation"] <- "Heteroscedasticity"
      
    } else {
      # No violation: Copy the uncorrected p-value to corrected and label as "No Violation"
      df[col, "p_value_corrected"] <- df[col, "p_value_uncorrected"]
      df[col, "Assumption_Violation"] <- "No Violation"
    }
  }
  
  # Apply BH correction to _p_value_uncorrected
  uncorrected_p_values <- as.numeric(df$p_value_uncorrected)
  uncorrected_p_values_adjusted <- p.adjust(uncorrected_p_values, method = "BH")
  df$p_value_uncorrected <- round(uncorrected_p_values_adjusted, 2)
  
  # Apply BH correction to p_value_corrected
  corrected_p_values <- as.numeric(df$p_value_corrected)
  p_values_adjusted <- p.adjust(corrected_p_values, method = "BH")
  df$p_value_corrected <- round(p_values_adjusted, 2)
  
  return(df)
}

# Run the function
table_ANCOVA <- ANCOVA_mult_cols(df_basis = Patients_vs_HC_imp_conf, 
                                 cols = imp_columns, 
                                 homoskedasticity_violations = homoskedasticity_results$Homoscedasticity_Violated, 
                                 interaction_violations = interaction_results$Interaction_Violated, 
                                 covariates = c("Alter", "Geschlecht", "Abschluss"))

# Output the final table
pander(table_ANCOVA, style = "rmarkdown", split.table = Inf, fontsize = "tiny")
```
