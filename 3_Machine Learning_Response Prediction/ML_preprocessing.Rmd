---
title: "Preprocessing_for_ML"
author: "Rebecca Delfendahl, Charlotte Meinke"
date: "2024-08-06"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
    df_print: paged
params:
  input_data_path: "Y:/PsyThera/Projekte_Meinke/Old_projects/Labrotation_Rebecca/0_Datapreparation/Taskdata/BIS/BIS_RT-trimmed-RT-wrong-removed_outliers-removed.csv"
  output_base_path: "Y:/PsyThera/Projekte_Meinke/Old_projects/Labrotation_Rebecca/2_Machine_learning/Feature_Label_Dataframes"
  response_criterion: "FSQ_perc_change" # choose between "Response_FSQ_50", "FSQ_perc_change", "Response_FSQ_clinsig", and "Response_BAT" 
---
<style type="text/css">
.main-container { /* Adjust main blocks */
  max-width: 100% !important;
  margin: auto;
}

body {
  font-family: "Georgia", serif !important; /* Set the font for the entire document */
}

.tocify { /* Adjust table of contents */
  max-width: 100% !important;
}
</style>

```{r R Setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,rows.print = 6, cols.min.print = 3)
library(dplyr)
library(tidyverse)
library(caret)
source("../Useful_functions.R")
```

# 1. Load relevant data and define paths
## Define paths
```{r}
socdem_file_path = "Y:/PsyThera/Projekte_Meinke/Old_projects/Labrotation_Rebecca/0_Datapreparation/Clinical_data/socdem-data_cleaned_response-added.csv"

# Define paths
output_path <- create_results_path(inputdata_path = params$input_data_path, output_mainpath = params$output_base_path,
                                        response_criterion = params$response_criterion)
output_path_share <- file.path("Y:/PsyThera/Projekte_Meinke/Old_projects/Labrotation_Rebecca/Make_model_available/Feature_Label_Dataframes", params$response_criterion)
dir.create(output_path_share, recursive = TRUE)
```
## Load task data
```{r}
task_data_all <- read.csv(params$input_data_path)
features_df <- get_group_data(data = task_data_all, group = c("Pat_Pre"))
```

## Add socdem and clinical variables
```{r}
socdem_clin_vars <- c("Alter", "Geschlecht", "Abschluss_Gymnasium", "T1_BAT_FAS_score", "T1_BAT_BDI_II_score", "T1_BAT_STAI_T_score", "T1_BAT_BIS_11_score", "T1_BAT_Kirby_k_score", "T1_BAT_CFC_14_score", "T1_BAT_SRHI_score", "BAT_T1")

features_df <- add_socdem_vars(features_df, socdem_file_path, socdem_clin_vars)
```

## Add response and exclude patients due with missing response
```{r}
features_df <- add_response(df = features_df, socdem_file_path = socdem_file_path, criterion = params$response_criterion)

features_df <- features_df %>%
  filter(!is.na(Response))
```
`r nrow(data_pat_pre) - nrow(data_pat_pre_clean)` patients were removed due to missing response criterion.


# 2. Renaming of features
```{r Prepare for ML}
# Drop variable "Subject"
features_df$Subject <- NULL

# Rename columns
features_df <- features_df %>%
  rename(is_woman = Geschlecht,
         Age = Alter,
         FAS = T1_BAT_FAS_score,
         BAT = BAT_T1,
         BDI_II = T1_BAT_BDI_II_score,
         STAI_T = T1_BAT_STAI_T_score,
         BIS_11 = T1_BAT_BIS_11_score,
         Kirby_k = T1_BAT_Kirby_k_score,
         CFC_14 = T1_BAT_CFC_14_score,
         SRHI = T1_BAT_SRHI_score,
         Abschluss_Gymnasium = Abschluss_Gymnasium)
```

# 3. Recode missing values for binary and non-binary features

```{r Missing values}
#var_category <- find_bin_cols(features_df_clean)
# TEST
bin_cols <- c("is_woman", "Abschluss_Gymnasium")
non_bin_cols <- setdiff(names(features_df), bin_cols) 

for (feature in bin_cols) {
  features_df[[feature]][is.na(features_df[[feature]])] <- 77777
}
for (feature in non_bin_cols) {
  features_df[[feature]][is.na(features_df[[feature]])] <- 99999
}
```

# 4. Create Labels_df
```{r}
labels_df <- features_df$Response
```


# 5. Create different feature sets
## 5.1 Baseline feature set (clinical features only)
```{r Reduced feature dataframe}
#clin_features <- c("is_woman", "Age", "Abschluss_Gymnasium", "FAS", "BAT", "BDI_II", "STAI_T", "BIS_11", "Kirby_k", "CFC_14", "SRHI")
clin_features <- c("is_woman", "Age", "Abschluss_Gymnasium", "FAS", "BAT", "BDI_II", "STAI_T")
clin_features_df <- features_df[clin_features]
```

## 5.2 All features (including executive functioning)
```{r Reduced feature dataframe}
task_features_interest <- c("NumberLetter_BIS_Repeat", "NumberLetter_BIS_Switch", 
                   "NumberLetter_BIS_Diff_Score", "Stroop_BIS_Congruent", 
                   "Stroop_BIS_Incongruent", "Stroop_BIS_Diff_Score", 
                   "TwoBack_BIS_Foil", "TwoBack_BIS_Target", "TwoBack_BIS_Total", 
                   "StopSignal_SSRT")
clin_task_features_df <- features_df[,c(clin_features, task_features_interest)]
```

## 5.3 Exploratory reasons: additional features
```{r}
#cols_n_trimmed <- colnames(features_df)[grep("n_trimmed_removed", colnames(features_df))]
#cols_n_wrong <- colnames(features_df)[grep("n_wrong_removed", colnames(features_df))]
#cols_accuracy <- colnames(features_df)[grep("Overall_PC", colnames(features_df))]
#addit_performance_features <- c(cols_n_trimmed, cols_n_wrong, cols_accuracy)

#all_features_final <- features_df[, !names(features_df) %in% addit_performance_features]
```

# 6. Save labels and features 
```{r Save dataframes, warning=FALSE}
write.csv(clin_task_features_df, file.path(output_path, "all_features.csv"), row.names = FALSE)
write.csv(clin_features_df, file.path(output_path, "clinical_features_only.csv"), row.names = FALSE)
if (params$response_criterion == "FSQ_perc_change"){
  write.csv(labels_df, file.path(output_path, "outcomes.csv"), row.names = FALSE)
} else {
  write.csv(labels_df, file.path(output_path, "labels.csv"), row.names = FALSE)
}
```

## 7 Only for the prediction of FSQ-response (50%): Create reduced feature set to share model publicly
This model does not contain the BAT as it is often not assessed.
```{r}
if (params$response_criterion == "Response_FSQ_50"){
  clin_features_reduced <- c("is_woman", "Age", "Abschluss_Gymnasium", "FAS", "BDI_II", "STAI_T")
  clin_features_reduced <- features_df[, clin_features_reduced]
  
  write.csv(clin_features_reduced, file.path(output_path_share, "clinical_features_only.csv"), row.names = FALSE)
  write.csv(labels_df, file.path(output_path_share, "labels.csv"), row.names = FALSE)
}
```
