---
title: "Preprocessing_for_ML"
author: "Rebecca Delfendahl"
date: "2024-08-06"
output: html_document
---

```{r R Setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,rows.print = 6, cols.min.print = 3)
library(dplyr)
library(tidyverse)
library(caret)
```

# 0. Load relevant data (only data of patients_pre are further processed)
```{r}
basic_path <- "Z:/Projekte_Meinke/Old_projects/Labrotation_Rebecca/Daten_Gruppenvergleich/With_wrong_responses"

task_data <- read.csv(file.path(basic_path,"Performance_Scores/Task_Performance_Scores.csv")) # contains overall accuracy
data_pat_pre <- read.csv(file.path(basic_path,"Data_Patients_Pre.csv"))
```

# 1. Exclude patients 
```{r}
data_pat_pre_clean <- data_pat_pre %>%
  filter(!is.na(Response)) # equals to NA at T1_BAT_FAS_score and/or T3_BAT_FAS_score
```
`r nrow(data_pat_pre) - nrow(data_pat_pre_clean)` patients were removed due to missing FAS_T1 and/or FAS_T3 (i.e. response criterion).

# 2. Add overall accuracy as additional feature (and PercentRmv if trials with wrong responses were discarded)
```{r}
features_df <- left_join(x = data_pat_pre_clean,
                         y = task_data %>% select(Subject, NumbLet_Average_PC,
                                                  Stroop_Average_PC,
                                                  TwoBack_Average_PC),
                         by = "Subject")
```

# 3. Encode classes (for classifier) vs. outcome (for regressor)
## 3.1. Classes (Responder vs. Non-Responder)
```{r Save labels in separate dataframe}
labels_df <- features_df["Response"]
features_df$Response <- NULL
```

## 3.2. Outcome (Percent-change in FAS)
```{r}
outcome_df <- data.frame(FAS_perc_change = ((features_df$T3_BAT_FAS_score - features_df$T1_BAT_FAS_score) / features_df$T1_BAT_FAS_score) * 100)
```

# 4. Dummy-Vars and renaming of features
```{r Prepare for ML}

# 1. OneHot-Encoding of variable "Abschluss"
features_df$Abschluss <- as.character(features_df$Abschluss)
dummy <- dummyVars(" ~ Abschluss", data = features_df)
trsf <- data.frame(predict(dummy, newdata = features_df, fullRank=TRUE))
features_df_enc <- cbind(features_df, trsf)

# 2. Drop variables "Abschluss", "Subject", "Gruppe", and "T3_BAT_FAS_score"
features_df_enc$Subject <- NULL
features_df_enc$Gruppe <- NULL
features_df_enc$Abschluss <- NULL
features_df_enc$T3_BAT_FAS_score <- NULL

# 3. Rename columns
features_df_enc <- features_df_enc %>%
  rename(is_woman = Geschlecht,
         Age = Alter,
         FAS = T1_BAT_FAS_score,
         BDI_II = T1_BAT_BDI_II_score,
         STAI_T = T1_BAT_STAI_T_score,
         BIS_11 = T1_BAT_BIS_11_score,
         Kirby_k = T1_BAT_Kirby_k_score,
         CFC_14 = T1_BAT_CFC_14_score,
         SRHI = T1_BAT_SRHI_score,
         Hauptschule = Abschluss1,
         Realschule = Abschluss2,
         Abitur = Abschluss3,
         anderer_Abschluss = Abschluss4)
```

# 5. Recode missing values for binary and non-binary features

```{r Missing values}

#var_category <- find_bin_cols(features_df_enc_clean)
# TEST
bin_cols <- c("is_woman", "Hauptschule", "Realschule", "Abitur", "anderer_Abschluss")
non_bin_cols <- setdiff(names(features_df_enc), bin_cols) 

# TODO: Replace bin_cols with var_category$binary and non_bin_cols with var_category$non_binary as soon as function find_bin_cols works
for (feature in bin_cols) {
  features_df_enc[[feature]][is.na(features_df_enc[[feature]])] <- 77777
}
for (feature in non_bin_cols) {
  features_df_enc[[feature]][is.na(features_df_enc[[feature]])] <- 99999
}
```

# 6. Create feature dataframe without executive task feature for hypothesis testing

```{r Reduced feature dataframe}
clin_features <- c("is_woman", "Age", "FAS", "BDI_II", "STAI_T", "BIS_11", "Kirby_k", "CFC_14", "SRHI", "Hauptschule", "Realschule", "Abitur", "anderer_Abschluss")
clin_features_df_enc <- features_df_enc[clin_features]
```

# 7. Save all 4 dataframes

```{r Save dataframes}
file_path <- "Z:/Projekte_Meinke/Old_projects/Labrotation_Rebecca/Feature_Label_Dataframes/"

write.csv(features_df_enc, paste0(file_path, "Features.csv"), row.names = FALSE)
write.csv(clin_features_df_enc, paste0(file_path, "Clinical_Features.csv"), row.names = FALSE)
write.csv(labels_df, paste0(file_path, "Labels.csv"), row.names = FALSE)
write.csv(outcome_df, paste0(file_path, "Outcome.csv"), row.names = FALSE)
```